
\section{Equivalence  modulo a certain equivalence relation}\label{sec:equivalence-modulo}
In this section, we present our main result, which says  that equivalence is decidable for graph-to-graph transducers of bounded treewidth, modulo a certain equivalence on the output graphs. This equivalence is a relaxation of isomorphism.  

\smallparagraph{Counting homomorphisms} The equivalence on output graphs is based on a paper by Grohe, Dell and Rattan~\cite{groheDellRattan2018}, which gives examples of how various equivalence relations on graphs, notably Weisfeiler-Leman equivalence, can be characterised in terms of counting homomorphisms. 

Define a \emph{homomorphism} from a graph $G$ to a graph $H$ to be any function $h$ from vertices of $G$ to vertices of $H$ which preserves edges in one direction: if there is an edge from $v$ to $w$ in $G$, then there is an edge from $h(v)$ to $h(w)$ in $H$. We write $\homset(G,H)$ for the set of homomorphism from $G$ to $H$. A seminal result of  Lov\'asz~\cite[p.~326]{lovasz1967operations} says that two graphs are isomorphic if and only if they admit the same number of homomorphisms from every graph:
\begin{align*}
\underbrace{G \simeq H}_{\text{isomorphism}} \qquad \text{iff} \qquad  |\homset(F,G)|=|\homset(F,H)| \ \text{for every graph $H$.}
\end{align*}
In~\cite{groheDellRattan2018},
Grohe, Dell and Rattan show that if one restricts the  class of graphs from which $F$ is taken, then one gets various well-studied relaxations of isomorphism. For example, if we only count homomorphisms from graphs $F$ of treewidth at most $k$, then the arising equivalence relation on graphs is Weisfeiler-Leman equivalence of dimension $k$.  The result of~\cite{groheDellRattan2018},  that we use in this paper counts homomorphisms from paths.

\begin{theorem}\label{thm:grohe}(\cite[Theorem 2]{groheDellRattan2018})
    For every  graphs $G_1,G_2$, the following  are equivalent:
    \begin{enumerate}
        \item for every $i \in \set{1,2,\ldots}$, if $P_i$ is the path of length $n$ then
        \begin{align*}
        |\homset(P_i,G_1) | = |\homset(P_i,G_2)|.
        \end{align*}
        \item $G_1$ and $G_2$  have the same number of vertices, say $n$, and there is an $n \times n$ square matrix $X$ with real coefficients such that:
        \begin{enumerate}
            \item each row in $X$ sums up to 1
            \item each column in $X$ sums up to 1
            \item $A_1 X = X A_2$, where $A_i$ is the incidence matrix of graph $G_i$.
        \end{enumerate}
    \end{enumerate}
\end{theorem}
Note that a homomorphism from a path of length $n$ is the same thing is a walk of length $n$, i.e.~a sequence of vertices connected by edges, possibly with repetitions.  In other words, condition 1 above says that for every $n$, the two graphs have the same number of walks of length $n$. The number of walks of length 1 is the number of vertices, and hence condition 1 implies that the graphs have the same number of vertices.     

Condition 2 in the above theorem can be seen as a relaxation of isomorphism in the following sense. 
If in condition 2 we add the requirement that all coefficients in $X$ are non-negative (real or rational, does not make a difference), then we get  \emph{fractional isomorphism}, which is characterised by homomorphisms from trees~\cite[Theorem 1]{groheDellRattan2018}. If we add the requirement that all coefficients in $X$ are non-negative integers, then we get isomorphism.  

\smallparagraph{Decidable equivalence, modulo counting homomorphisms from paths} 
In the following theorem, we show that equivalence for graph-to-graph \mso transductions of bounded treewidth is decidable, when output graphs are identified modulo the equivalence relation from Theorem~\ref{thm:grohe}. 
% We would have preferred to prove decidability of equivalence modulo isomorphism, but so far we have only managed to apply our technique to the equivalence relation from Theorem~\ref{thm:grohe}.
\begin{theorem}\label{thm:path-equivalence}
    Let $\sim$ be the equivalence relation on graphs described in Theorem~\ref{thm:grohe}. 
    The following problem is decidable:
    \decisionproblem{$\sim$-functionality for graph-to-graph \mso transductions of bounded treewidth.}{ $\ell, k \in \set{1,2,\ldots}$ and a graph-to-graph \mso transductions $\Tt$.}{is there some input of treewidth at most $\ell$, which can produce two outputs of treewidth at most $k$ that are not equivalent under $\sim$?}
\end{theorem}
% By Lemma~\ref{lem:transduction-to-registers}, the above problem reduces to deciding $\sim$-functionality for nondeterministic tree-to-$\aalg$ register transducers, where $\aalg$ is the algebra of $k$-sourced graphs. Here, $\sim$-functionality means that output graphs are identified modulo $\sim$. 
 
For the same reasons as in Fact~\ref{fact:equi-decidable}, the above problem is equi-decidable with the $\sim$-equivalence problem, where one asks if two functional transductions produce $\sim$-equivalent outputs, under assumption of bounded treewidth. 

The rest of this section is devoted to showing decidability for the  $\sim$-functionality problem. We first show how a register transducer can compute a representation of the output graph modulo $\sim$ in terms of a power series (Section~\ref{sec:power-series}), and then we show that equivalence is decidable for register transducers which manipulate such power series (Section~\ref{sec:decide-power-series}). Combining this with the reduction to register transducers from Lemma~\ref{lem:transduction-to-registers}, we get the theorem.

\subsection{Computing the power series for walks in a graph}
\label{sec:power-series}
Define a \emph{univariate formal power series over a semiring $\Ring$} to be  sequence of semiring elements $a_0,a_1,\ldots$ which is represented as an infinite univariate polynomial
\begin{align*}
 A = a_0 + a_1x^1 + a_2x^2 + \cdots.
\end{align*}
We simply say power series, instead of univariate formal power series.
We use the name $i$-th term for $a_i$; and we call $a_0$ the constant term.
We write $\powerseries{\Ring}$ for the  power series over a semiring $\Ring$; this is a semiring. Among all power series, we are particularly interested in the rational ones: a power series is called \emph{rational} if it can be generated from finite power series (a finite power series is one where all but finitely many terms are zero) using the semiring operations $+$ and $\times$ of power series, as well as the following unary  operation called \emph{Kleene plus}:
\begin{align*}
 A^+ \eqdef A + A^2 + A^3 + \cdots,
\end{align*}   
which  is defined only when the constant term   in $A$ is zero. The assumption on a zero constant term ensures that the infinite sum in $A^+$ is well defined: under this assumption, the $i$-th term in $A^j$ with $j>i$ is zero. 


For a graph $G$, define its \emph{walk series} to be the power series 
\begin{align*}
  a_1 x^1 + a_2x^2 + \cdots \qquad \text{where $a_i$ is the number of walks in $G$ of length $i$.}
\end{align*}
Almost by definition, two graphs are $\sim$-equivalent if and only if they have the same walk series. 
The first step in the proof of Theorem~\ref{thm:path-equivalence} is the following lemma, which says  that the walk series is always  rational, and can be computed by a register transducer.
\begin{lemma}\label{lem:compute-power-series}    
    Define  $\aalg$ to be the  algebra where
    \begin{description}
        \item[Domain:]power series in $\powerseries \Nat$ which are rational and have a  zero constant term;
        \item[Operations:] $+$, $\times$, Kleene plus and constants $1$ and $x$.
    \end{description}
    For every $k \in \set{1,2,\ldots}$ and every register transducer $\Aa$ over the algebra of $k$-sourced graphs, there is a  register transducer $\Bb$ over $\aalg$ which makes the following diagram commute (arrows are binary relations):
    \begin{align*}
    \xymatrix@C=1cm{
       &  \trees \Sigma   
        \ar[dr]^{\Bb}
        \ar[dl]_{\Aa} \\
        \txt{graphs of
        treewidth $< k$} \ar[rr]_-{G \mapsto \text{walk series of $G$}}& & \aalg
    }
    \end{align*}
\end{lemma}
\begin{proof}
    
    %J
    
        % The proof is an adaptation of a weighted version of the usual ''DFA to regular expression conversion'' (i.e. weighted automaton to rational power series), with state elimination corresponding to source forgetting.
    
        
        % Define an \emph{internal walk} to be a walk that does not visit any sources,  with the possible exception of the first and last vertices in the walk, which are allowed to be sources. 
        Define the \emph{source number} of a vertex in a $k$-sourced graph to be  $i \in \set{1,\ldots,k}$ if the vertex is the $i$-th source, and $0$ otherwise. For
        $i,j \in \set{0,\ldots,k}$,
        define an  $(i,j)$-walk to be a walk where the first vertex has source number $i$, the last vertex has source number $j$, and the remaining vertices in the walk are not sources (i.e.~their source number is $0$). For a $k$-sourced graph $G$, define 
        \begin{align*}
        \varphi_{ij}(G) \in \aalg
        \end{align*}
         to be the power series where the $n$-th term is the number of nonempty $(i,j)$-walks of length $n$. In particular, the constant term  of this power series is zero, since we only consider nonempty walks. Define 
        \begin{align*}
        \varphi(G) \in \aalg^{\set{0,\ldots,k}^2}
        \end{align*}
        to be the tuple of all of the values returned by the functions $\varphi_{ij}$. 
        The main observation is that $\varphi$ is an algebra homomorphism, in the following sense.
        \begin{claim}
            For every term operation $f$ 
            in the algebra of $k$-sourced graphs, there is a term operation $f^\varphi$ in the algebra $\aalg$ which makes the following diagram commute
            \begin{align*}
            \xymatrix{
                (\text{$k$-sourced graphs})^X 
                \ar[r]^f
                \ar[d]_{\varphi^X}
                &
                 (\text{$k$-sourced graphs})^Y
                \ar[d]^\varphi
                \\
                \aalg^{\set{0,\ldots,k}^2 \times X}
                \ar[r]_{f^\varphi}
                &
                \aalg^{\set{0,\ldots,k}^2 \times Y}
            }
            \end{align*}
        \end{claim}
        Before proving the claim, we use it to finish the proof of the lemma. Suppose that $\Aa$ is a register transducer over the algebra of $k$-sourced graphs. The register transducer  $\Bb$, which is over the algebra $\aalg$, has the same input alphabet, and its registers are triples 
        \begin{align*}
        (i,j,r) \qquad \text{where $i,j \in \set{0,\ldots,k}$ and $r$ is a register of $\Aa$.}
        \end{align*}
         The register updates of $\Bb$ are defined by applying the homomorphism from the claim  to the register updates of $\Aa$. 
        The output register of $\Bb$ is $(0,0,r)$, where  $r$ is the output register of $\Aa$.  From the claim it follows 
        \begin{align*}
        \text{$\Aa$ can output $G$ on input $t$} \qquad \iff \qquad 
        \text{$\Bb$ can output $\varphi_{00}(G)$ on input $t$}.
        \end{align*}
        Since $\varphi_{00}(G)$ is the walk series of $G$ when $G$ has no sources, the lemma follows. It remains to prove the claim.

        \begin{proof} 
            It is enough to prove the claim for the case when $f$ is one of the basic operations in the algebra of $k$-sourced graphs. In particular, $Y$ has one element. Here the proof is similar to conversion of a nondeterministic automaton into a regular expression, as in the Kleene Theorem.
            
            \begin{itemize}
                \item Suppose that $f$ is a constant, which represents a  $k$-sourced graph where all vertices are sources. Then we have 
                \begin{align*}
                \varphi_{ij}(f) = \begin{cases}
                    1 & \text{if there is an edge from $i$ to $j$ in $f$}\\
                    0 & \text{otherwise.}
                \end{cases}
                \end{align*}
                \item Suppose that $f$ is the  basic operation which inputs two $k$-sourced graphs and outputs their fusion.  
                An $(i,j)$-walk in the fusion $f(G_1,G_2)$ is the same thing as an $(i,j)$-walk in $G_1$ or an $(i,j)$-walk in $G_2$. Furthermore, these cases are disjoint, since we are working with graphs that have parallel edges.  This leads to the following equation for fusions:
                \begin{align*}
                \varphi_{ij}(f(G_1,G_2)) = \varphi_{ij}(G_1) + \varphi_{ij}(G_2).
                \end{align*}
                The right hand side uses component-wise addition, which is a basic operation in $\aalg$.
                \item The last case is when $f$ is a unary operation which forgets  source $c \in \set{1,\ldots,k}$.  Let then $G$ a $k$-sourced graph. A nonempty $(i,j)$-walk in $f(G)$ is either a nonempty $(i,j)$-walk in $G$, or it has the form
                \begin{enumerate}
                    \item a nonempty $(i,c)$-walk in $G$; followed by 
                    \item finitely many (possibly zero) nonempty  $(c,c)$-walks in $G$; followd by
                    \item a nonempty $(c,i)$-walk in $G$.
                \end{enumerate}
                This leads to the following equation:
                \begin{align*}
                \varphi_{ij}(f(G))) = \varphi_{ij}(G)) +  \varphi_{ic}(G) \times (1+ \varphi_{cc}(G))^+  \times \varphi_{cj}(G).
                \end{align*}                
            \end{itemize}
        \end{proof}
        
\end{proof}

\subsection{Equivalence for transducers that output rational power series}
\label{sec:decide-power-series}
By Lemmas~\ref{lem:transduction-to-registers} and~\ref{lem:compute-power-series}, the  equivalence problem from Theorem~\ref{thm:path-equivalence} reduces to functionality for nondeterministic tree-to-$\aalg$ register transducers, where $\aalg$ is the algebra from Lemma~\ref{lem:compute-power-series}. In this section, we complete the proof the theorem by showing that the latter problem is decidable.
\begin{lemma}\label{lem:functionality-decidable-power-series} If $\aalg$ is the algebra from Lemma~\ref{lem:compute-power-series}, then functionality is decidable for nondeterministic tree-to-$\aalg$ register transducers. 
\end{lemma}
\begin{proof}
    First, let us recall that equivalence is decidable for algebra \aalg without Kleene plus, i.e. for ring of one-variable rational power series  (see Theorem \ref{thm:equivalence-polynomial-automata-over-a-ring}) and this is the problem we are going to reduce to.
    
  	Observe that $ff^+ + f = f^+$, hence
  	$$
  		f^+ = \frac{f}{1-f}.
  	$$
  	This makes tree-to-\aalg register transducer a polynomial tree automaton \emph{with division}, an extension of a notion of polynomial automaton \cite{worrellBenediktDuffSharad2017}(also called polynomial program (without disequality guards) in \cite{seidlMuller-polynomial-programs04}), to tree inputs, more general output rings, and using division during computation, which we introduce below.
  	\begin{definition}
  		A \emph{polynomial automaton with division} is a register transducer over an algebra $(R, +, \times, \div)$, where $(R, +, \times)$ is a field, $\div$ is division operation, which has a semantic property of never dividing by 0, in any update, in any run.
  	\end{definition}
  		The rest of the proof is devoted to showing that equivalence is decidable for polynomial automata with division. We will now proceed as in the classical construction of projective line.
  		
  		Let $R$ be any field, e.g. of one-variable rational functions. Shortly speaking, the reduction is given by the fact, that when elements of $R$ are represented (non-uniquely) as pairs $(x,y)\in R^2$, where $(x,y)$ represents $\frac{x}{y}$ (assume $y$ is invertible, e.g. 1) then division in $R$ becomes a polynomial function in $R^2$. The same holds for operations $+, \cdot$.
  
  		Formally, since
  		\begin{align*}
  			&\frac{x}{y} + \frac{z}{t} = \frac{xt+yz}{yt},\\ 
  			&\frac{x}{y} \cdot \frac{z}{t} = \frac{xz}{yt},\\
  			&\left(\frac{x}{y}\right)^+ = \frac{\frac{x}{y}}{1-\frac{x}{y}} = \frac{x}{y-x},
  		\end{align*}
  		we define an algebra $B$ the following way:
  		\begin{itemize}
  			\item universe is $R \times R$,
  			\item operations: operations $+_B, \cdot_B$ of arity 2, operation $^+$ of arity 1:
  			\begin{align*}
  				&(x,y) +_B (z,t) = (xt+yz, yt),\\
  				&(x,y)\cdot_B(z,t) = (xz, yt),\\
  				&(x,y)^{+_B} = (x, y-x).
  			\end{align*}
  		Now, for $\Aa$ being polynomial tree automaton with division over ring $R$, one can make a polynomial tree automaton (without division) $\Bb$, using equations above in a similar way as in Lemma \ref{lem:compute-power-series}. Then for each input tree $t$, $\Bb(t)$ represent $\Aa(t)$, i.e.
  		$$
  			\Bb(t) = (x,y), \text{ where } \frac{x}{y} = \Aa(t).
  		$$
  		
  		Thus the reduction is as follows: for polynomial tree automata with division $\Aa_1, \Aa_2$ take corresponding polynomial tree automata $\Bb_1, \Bb_2$. Then we get $\Aa_1 \equiv \Aa_2 \Leftrightarrow (xt-yz)\circ(\Bb_1, \Bb_2) \equiv 0$ ($(xt-yz)\circ(\Bb_1, \Bb_2)$ is a polynomial automaton).
  		\end{itemize}


  		
\end{proof}
