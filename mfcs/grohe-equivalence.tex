
\section{Equivalence  modulo a certain equivalence relation}
In this section, we present our main result, which says  that equivalence is decidable for graph-to-graph transducers of bounded treewidth, modulo a certain equivalence on the output graphs which is more relaxed than isomorphism.  

\smallparagraph{Counting homomorphisms} We begin by describing the equivalence on output graphs.
This equivalence is based on a paper by Grohe, Dell and Rattan~\cite{groheDellRattan2018}, which gives examples of how various equivalence relations on graphs, notably Weisfeiler-Leman equivalence, can be characterised in terms of counting homomorphisms. 

Define a \emph{homomorphism} from a graph $G$ to a graph $H$ to be any function $h$ from vertices of $G$ to vertices of $H$ which preserves edges in one direction: if there is an edge from $v$ to $w$ in $G$, then there is an edge from $h(v)$ to $h(w)$ in $H$. We write $\homset(G,H)$ for the set of homomorphism from $G$ to $H$. A seminal result of  Lov\'asz~\cite[p.~326]{lovasz1967operations} says that two graphs are isomorphic if and only if they admit the same number of homomorphisms from every graph:
\begin{align*}
\underbrace{G \simeq H}_{\text{isomorphism}} \qquad \text{iff} \qquad  |\homset(F,G)|=|\homset(F,H)| \ \text{for every graph $H$}
\end{align*}
In~\cite{groheDellRattan2018},
Grohe, Dell and Rattan show that if one restricts the  class of graphs from which the domain $F$ of the homomorphism is taken, then one gets various well-studied relaxations of isomorphism. For example, if we only count homomorphisms for graphs $F$ of treewidth at most $k$, then the arising equivalence relation on graphs is Weisfeiler-Leman equivalence of dimension $k$.  Among the results of~\cite{groheDellRattan2018}, the one that we use in this paper is the following one, which counts homomorphisms from paths.

\begin{theorem}\label{thm:grohe}(\cite[Theorem 2]{groheDellRattan2018})
    For two graphs, the following conditions are equivalent:
    \begin{enumerate}
        \item for every $i \in \set{1,2,\ldots}$, if $P_i$ is the path of length $n$ then
        \begin{align*}
        |\homset(P_i,G_1) | = |\homset(P_i,G_2)|.
        \end{align*}
        \item there graphs have the same number of vertices, say $n$, and there is an $n \times n$ square matrix $X$ with real coefficients such that:
        \begin{enumerate}
            \item each row in $X$ sums up to 1
            \item each column in $X$ sums up to 1
            \item $A_1 X = X A_2$, where $A_i$ is the incidence matrix of graph $G_i$.
        \end{enumerate}
    \end{enumerate}
\end{theorem}
Note that a homomorphism from a path of length $n$ is the same thing is a walk of length $n$, i.e.~a sequence of vertices connected by edges, possibly with repetitions.  In other words, condition 1 above says that for every $n$, the two graphs have the same number of walks of length $n$. The number of walks of length 1 is the number of vertices, and hence condition 1 implies that the graphs have the same number of vertices.     

Condition 2 in the above theorem can be seen as a relaxation of isomorphism in the following sense. 
If in condition 2 we add the requirement that all coefficients in $X$ are non-negative (real or rational, does not make a difference), then we get  \emph{fractional isomorphism}, which is characterised by homomorphisms from trees~\cite[Theorem 1]{groheDellRattan2018}. If we add the requirement that all coefficients in $X$ are non-negative integers, then we get isomorphism.  

\smallparagraph{Decidable equivalence, modulo counting homomorphisms from paths} 
In the following theorem, we show that equivalence for graph-to-graph \mso transductions of bounded treewidth is decidable, when output graphs are identified modulo the equivalence relation from Theorem~\ref{thm:grohe}. 
% We would have preferred to prove decidability of equivalence modulo isomorphism, but so far we have only managed to apply our technique to the equivalence relation from Theorem~\ref{thm:grohe}.
\begin{theorem}\label{thm:path-equivalence}
    Let $\sim$ be the equivalence relation on graphs described in Theorem~\ref{thm:grohe}. 
    The following problem is decidable:
    \decisionproblem{$\sim$-equivalence for functional graph-to-graph \mso transductions of bounded treewidth.}{ $\ell, k \in \set{1,2,\ldots}$ and functional graph-to-graph \mso transductions $\Tt_1,\Tt_2$.}{is it the case that for every input $G$ of treewidth at most $\ell$, the two outputs  $\Tt_1(G),\Tt_2(G)$ are $\sim$-equivalent and have treewidth at most $k$?}
\end{theorem}
% By Lemma~\ref{lem:transduction-to-registers}, the above problem reduces to deciding $\sim$-functionality for nondeterministic tree-to-$\aalg$ register transducers, where $\aalg$ is the algebra of $k$-sourced graphs. Here, $\sim$-functionality means that output graphs are identified modulo $\sim$. 
 
The rest of this section is devoted to showing decidability for the above $\sim$-functionality problem. We first show how a register transducer can compute a representation of the output graph modulo $\sim$ in terms of a power series (Section~\ref{sec:power-series}), and then we show that equivalence is decidable for register transducers which manipulate such power series (Section~\ref{sec:decide-power-series}). Combining this with the reduction to register transducers from Lemma~\ref{lem:transduction-to-registers}, we get the theorem.

\subsection{Computing the power series for walks in a graph}
\label{sec:power-series}
Define a \emph{univariate formal power series over a semiring $\Ring$} to be  sequence of semiring elements $a_0,a_1,\ldots$ which is represented as an infinite univariate polynomial
\begin{align*}
 A = a_0 + a_1x^1 + a_2x^2 + \cdots.
\end{align*}
We simply say power series, instead of univariate formal power series.
We use the name $i$-th term for $a_i$; and we call $a_0$ the constant term.
We write $\powerseries{\Ring}$ for the  power series over a semiring $\Ring$; this is a semiring. Among all power series, we are particularly interested in the rational ones: a power series is called \emph{rational} if it can be generated from finite power series (a finite power series is one where all but finitely many terms are zero) using the semiring operations $+$ and $\times$ of power series, as well as the following unary  operation called \emph{Kleene plus}:
\begin{align*}
 A^+ \eqdef A + A^2 + A^3 + \cdots,
\end{align*}   
which  is defined only when the constant term   in $A$ is zero. The assumption on a zero constant term ensures that the infinite sum in $A^+$ is well defined: under this assumption, the $i$-th term in $A^j$ with $j>i$ is zero. 


For a graph $G$, define its \emph{path series} to be the power series 
\begin{align*}
  a_1 x^1 + a_2x^2 + \cdots \qquad \text{where $a_i$ is the number of walks in $G$ of length $i$.}
\end{align*}
Almost by definition, two graphs are $\sim$-equivalent if and only if they have the same path series. 
The first step in the proof of Theorem~\ref{thm:path-equivalence} is the following lemma, which says  that the path series is always  rational, and can be computed by a register transducer.
\begin{lemma}\label{lem:compute-power-series}    
    Let $\aalg$ be the algebra where:
    \begin{description}
        \item[Domain:]power series in $\powerseries \Nat$ which are rational and have a  zero constant term;
        \item[Operations:] $+$, $\times$, Kleene plus and constants $1$ and $x$.
    \end{description}
    For every $k \in \set{1,2,\ldots}$ and every nondeterministic  \treetotreewidth{ k} register transducer $\Aa$, there is a nondeterministic tree-to-$\aalg$ register transducer $\Bb$ which makes the following diagram commute (arrows are binary relations):
    \begin{align*}
    \xymatrix@C=4cm{
        \trees \Sigma   
        \ar[dr]^{\Bb}
        \ar[d]_{\Aa} \\
        \txt{graphs of\\
        treewidth $\le k$} \ar[r]_{G \mapsto \text{path series of $G$}}& \aalg
    }
    \end{align*}
\end{lemma}
\begin{proof}
        The proof is an adaptation of a weighted version of the usual ''DFA to regular expression conversion'' (i.e. weighted automaton to rational power series), with state elimination corresponding to source forgetting.
    
    Denote set of source nodes by $\sources(G)$ and set of nonsource nodes by a symbol $\bullet$. Define $\varphi$ to map a sourced graph $G$ to a tuple of power series in the following way:
    $$
    \varphi: G \longmapsto (g_{i,j})_{i,j \in \allv{G}},
    $$
    where $g_{i,j}$ is the power series of set of walks from $i$ to $j$ which are positive length and whose interiors do not touch sources (if $j=\bullet$ we take the set of such walks from $i$ to any nonsource node). More precisely, $g_{i,j} = \sum_{n=1}^{\infty} a_n x^n$, where $a_n$ is the number of such walks of length $n$. Note that a particular $g_{i,j}$ is defined if all sources among $\{i,j\}$ are defined. A graph without sources is mapped to (a tuple with one element:) $g_{\bullet, \bullet}$ and obviously for graphs without sources $G, H$ we have $\varphi(G) = \varphi(H)$ if and only if $G \sim H$.
    
    Now let us investigate how $\varphi(\forget_k(G))$ and $\varphi(\join(G, H))$ can be reconstructed from $\varphi(G), \varphi(H)$.
    Observe that:
    \begin{align}\label{eq:equationForForget}
    	\forget_k(G)_{i,j} &= g_{i,j} + g_{i,k}\cdot(1 + g_{k,k}^+)\cdot g_{k_j},\\
    	\join(G, H)_{i,j} &= g_{i,j} + h_{i,j} \ (- x \text{ if there is an edge } i\text{--}j \text{ in both } G \text{ and } H)
    	\label{eq:equationForJoin}
    \end{align}
    The substraction of $x$ in second equation serves for not counting length-1 walk $i$--$j$ twice, in case it exists both in $G$ and $H$.
    
    Above equations can be written in a form that will be suitable in the rest of this proof:
    \begin{align}
    	\label{eq:interpretationInAfirst}
   		\varphi(\forget_k(G)) &= (\varphi(G)_{i,j} + \varphi(G)_{i,k}\cdot(1 + \varphi(G)_{k,k}^+)\cdot \varphi(G)_{k_j})_{i,j \in \allv{G}},\\
    	\varphi(\join(G, H)) &= (\varphi(G)_{i,j} + \varphi(H)_{i,j}
    	\label{eq:interpretationInAlast}
    \end{align}
    with equation \eqref{eq:interpretationInAlast} modified like equation 
    The above equations hold, just as in ''DFA to regular expression'' case, because they are substitutions of equalities of sets of walks ($g_{i,j}$ can be obtained from set of walks by substituting $x$ for each edge), and substitution respects operations $+, \cdot, ^+$.
    
	Let us now construct transducer $\Bb$, which, shortly and informally speaking is an interpretation of $\Aa$ via equations \eqref{eq:interpretationInAfirst}-\eqref{eq:interpretationInAlast}.
	\begin{itemize}
		\item for each register $R$ of $\Aa$ create a tuple $(R_{i,j})_{i, j \in \allv{G}}$ of registers of $\Bb$.
		\item for each initial register valuation $\rho \in A^k$ create initial register valuation $(R_{i,j})_{i,j\in\allv{G}} := \varphi(\rho(R))$,
		\item for each input letter $a$, denote its arity by $n$, for each register update $p = (R:= p_R(\Registers^n) \text{ for } R \in \Registers)$ create a register update $\varphi\circ p$, defined as $((R_{i,j})_{i,j} := \varphi(p_R(\Registers^n)) \text{ for } R\in\Registers)$ where each function $\varphi\circ p_R$ is realized by a term over $A$ obtained from $p_R$ using equations \eqref{eq:interpretationInAfirst}-\eqref{eq:interpretationInAlast}.
	\end{itemize}
	A final remark is that $\Bb$, in order to do a register update, also needs to keep an information about edges between sources of graphs in registers. This however is finite information which can be easily updated and thus can be stored in states, which can be later removed, as observed in (fill-in reference).
\end{proof}

\subsection{Equivalence for transducers that output rational power series}
\label{sec:decide-power-series}
By Lemmas~\ref{lem:transduction-to-registers} and~\ref{lem:compute-power-series}, the  equivalence problem from Theorem~\ref{thm:path-equivalence} reduces to functionality for nondeterministic tree-to-$\aalg$ register transducers. In this section, we complete the proof the theorem by showing that the latter problem is decidable.
\begin{lemma}\label{lem:functionality-decidable-power-series} If $\aalg$ is the algebra from Lemma~\ref{lem:compute-power-series}, then functionality is decidable for nondeterministic tree-to-$\aalg$ register transducers. 
\end{lemma}
\begin{proof}
    (fill in)
\end{proof}

