\section{Graphs, treewidth, and logic on graphs}
The graphs in this paper are finite and undirected, with parallel edges, with no loops. Formally, we define a \emph{graph} to be a tuple consisting of a set of vertices, set of edges and a function that associates to each edge the two-element set of its endpoints. We call distinct edges \emph{parallel} if their sets of endpoints are equal. Theorems we cite (for example \cite[Proposition 4.1]{courcelleEtAlAlgebraicTheoryOfGraphReduction93}, \cite[Theorem 2]{groheDellRattan2018}) were originally formulated for graphs with no parallel edges, but they easily lift to graphs that allow parallel edges.

\subsection{Treewidth} 
\label{sec:treewidth-definition}
For every class of graphs with unbounded treewidth, its \mso theory (assuming the \msotwo encoding described later in this paper) is undecidable~\cite[Theorem 8]{seese1991structure}. This undecidability result immediately extends to the equivalence problems for \mso transductions that are studied in this paper. Therefore, we  only consider classes of graphs of bounded treewidth. 
%a może: we only consider transductions where input classess have bounded treewidth (this implies output classess have bounded treewidth too (fill-in citation))
To define treewidth, we use Courcelle's  approach via universal algebra \cite{courcelleEtAlAlgebraicTheoryOfGraphReduction93}. (Later on in the paper, we also use algebra in the classical sense: rings, fields, polynomials, etc.)


\smallparagraph{Algebras and terms operations} We begin by introducing some terminology from universal algebra. By an \emph{algebra}, we mean an underlying set equipped with some  operations, e.g.~the ring of integers $(\Int, + , \times, 0, 1)$ or the free monoid $(\Sigma^*, \cdot, \varepsilon)$. We write $\aalg, \balg, \ldots$ for algebras. By abuse of notation, we write $a \in \aalg$ if $a$ belongs to the underlying set in the algebra $\aalg$. 

We use the name \emph{basic operations} for the operations that are given in the algebra. This is to distinguish them from the more general \emph{term operations}, which are defined below.
        For two finite sets $X,Y$ and an algebra $\aalg$, a function
        \begin{align*}
            f : \aalg^X \to \aalg^Y,
            \end{align*}
            is called a \emph{term operation} if it is induced by a family of terms, one for each $y \in Y$, with each term  constructed using the basic operations of the algebra and variables from $X$.  If the set $Y$ has one element, then we talk about term operations of type $\aalg^X \to 
        \aalg$, and if furthermore the set $X$ is $\set{0,\ldots,k-1}$ then we talk about term operations of type $\aalg^k \to \aalg$. 

        For example, the polynomial
        \begin{align*}
        f : \Real \to \Real \qquad x \mapsto 3x^2 -2x+1,
        \end{align*}
     and more generally any polynomial with integer coefficients,  is a term operation in the algebra
        \begin{align*}
            (\Real, +,\times, -1,0,1).
        \end{align*}
        Polynomials with non-integer coefficients such as $0.5$  are not term operations; for this the coefficients would need to be added as constants to the algebra. 
        % In the same algebra, an example of a  for this the 
        % while the operation $x \mapsto xa$ which appends an 
        %  the operation $x \mapsto xx$ is a unary term operation. 
        % set $X$ of variables,  define a \emph{term operation with  variables $X$ in an algebra $\aalg$} to be  any operation of type $\aalg^X \to \aalg$ that arises from a term constructed using  variables $X$ and operations of the algebra.  For example, $x \mapsto xxx$ is a term operation in the free monoid. 
        % If the set of variables is $X=\set{1,\ldots,k}$, then we talk about $k$-ary operations. We  also use 
        %  \emph{vectorial term operation};  is a function
        
        % which arises from a family of term operations $f_y : \aalg^X \to \aalg$, one for each $y \in Y$.
        %  For example,  the term $xyxxy$ over variables $\set{x,y}$ in the free monoid gives rise to a binary term operation in the free monoid. 
        % A \emph{polynomial operation with variables $X$} is defined in the same way, except that the term can also use all elements of the algebra as constants.  Here is another example, which explains the terminology: if  the algebra $\aalg$ is 
        % $
        % (\Real, + , \times, 0 ,1)
        % $
        % then the $k$-ary term operations are the same as polynomials with $k$ variables with coefficients in $\set{0,1,\ldots}$, while the $k$-ary polynomial operations are the same as (general) polynomials with $k$ variables.

        
        
\smallparagraph{The algebra of $k$-sourced graphs} To define treewidth, we consider graphs with distinguished vertices and equip them with an algebraic structure. 
    Let $k \in \set{1,2,\ldots}$. Define a $k$-sourced graph to be a  graph together with a $k$-tuple of pairwise distinct vertices called \emph{sources}. We allow sources to be undefined; in particular when all sources are undefined then we get a graph. Here is a 
    picture of a 3-sourced graph, where sources 1 and 3 are defined, but source 2 is undefined:
    \mypic{2}
    We view  $k$-sourced graphs as an algebra, in the following sense.



    
    \begin{definition}
        [Algebra of $k$-sourced graphs] Let $k \in \set{1,2,\ldots}$. The \emph{algebra of $k$-sourced graphs} has as its underlying set the  $k$-sourced graphs,  with the following basic operations:
            \begin{itemize}
                \item {\bf Constants.} There is a constant for every $k$-sourced graph where all vertices are sources and there is at most one edge.
                \item {\bf Forget.} For every $i \in \set{1,\ldots,k}$ there is a unary operation, which inputs a $k$-sourced graph and outputs the same $k$-sourced graph, except that the $i$-th source is undefined. 
                \item {\bf Fuse.} There is one binary operation, called \emph{fusion}, which inputs two $k$-sourced graphs, and output their disjoint union, with same-numbered sources being identified, as explained in the following picture (note that fusion of graphs without parallel edges might contain parallel edges):
                \mypic{1}
            \end{itemize}
        \end{definition}
    
        Terms in this algebra correspond to tree decompositions in the original sense of Robertson and Seymour~\cite[Section 12.3]{diestel}. More precisely, a graph has treewidth $\leq k$  if and only if it can be produced using the operations of the algebra of $(k+1)$-sourced graphs \cite[Proposition 4.1]{courcelleEtAlAlgebraicTheoryOfGraphReduction93}. This justifies the following definition.


  \begin{definition}[Treewidth]
        For $k \in \set{1,2,\ldots}$, we say that a  graph has treewidth  $\le  k$ if it can be produced using the operations of the algebra of $(k+1)$-sourced graphs.
    \end{definition}

  
    
    % The definition above coincides with the original definition of Robertson and Seymour, which uses tree decompositions with bags of vertices~\cite[Proposition 1.19]{courcelle1991}. 

    \subsection{Monadic second-order logic}
    We  use logic, especially monadic second-order logic, to define properties and transformations of graphs. 

    \smallparagraph{Logical terminology}
    A  \emph{vocabulary} is defined to be  a set of relation names, each one with an associated arity. A \emph{model over vocabulary $\tau$} consists of a set, called the \emph{universe} of the model, together with an \emph{interpretation}, maps the relations names from the vocabulary $\tau$ to  relations over the universe of same arity. To define properties of such models, we use mainly monadic second-order logic \mso, which  is the extension of first-order logic that allows quantification over sets of elements (but not sets of pairs, or triples, etc.). We assume that the reader is familiar with \mso, for an introduction see~\cite[Section 2]{Thomas97}.
     
     
      To define properties of graphs in \mso, we represent a graph as models. There are at least two ways to do this, called  \msoone and \msotwo following 
 Courcelle~\cite[Definition 1.7]{courcelleVI}. In the \msoone model, which is defined only for graphs with no parallel edges, the  universe is the vertices and there is a binary relation for the edges (the binary relation is symmetric, because graphs are undirected). In the \msotwo model, the universe is the disjoint union of vertices and edges, and there is a binary  \emph{incidence relation} that consists of pairs $(v,e)$ such that vertex $v$ participates in edge $e$. 
In this paper, we use the \msotwo model. For general graphs with no parallel edges, more properties of graphs can be expressed in \mso using the \msotwo representation, e.g.~existence of a Hamiltonian cycle can be expressed using the \msotwo representation but not with the \msoone representation~\cite[p.~118]{courcelleVI}. However, for graphs of bounded treewidth with no parallel edges, \msoone and \msotwo have the same expressive power~\cite[Theorem 9.37]{courcelleGraphStructureMonadic2012}. 

\smallparagraph{Transductions}  The central topic of this paper is \mso transductions, which are graph transformations definable in \mso. In principle, the transductions are nondeterministic -- i.e.~they represent binary relations and not functions -- but we will show that the case of functions is general for the equivalence problems that we consider.

% \begin{definition}\label{def:graph-to-graph-mso}
%     The syntax of a graph-to-graph \mso transduction consists of:
%         \begin{enumerate}
%             \item a finite set of colours $C$;
%             \item a copying constant $k \in \set{1,2,\ldots}$;
%             \item \label{msotrans:formulas} two \mso formulas -- a universe formula with one free variable, and an incidence formula with two free variables --  over the following relational vocabulary
%             \begin{align*}
%             \underbrace{\mathrm{incident}(x_1,x_2)}_{\txt{arity 2}}  \qquad
%             \underbrace{\mathrm{copy}(x_1,\ldots,x_k)}_{\txt{arity $k$}}  \qquad 
%             \underbrace{\mathrm{colour}_c(x)\ \text{for $c \in C$}}_{\txt{arity 1}}.
%             \end{align*}
%         \end{enumerate}
% \end{definition}
% The semantics of an \mso transdution is a binary relation on graphs, which is defined as follows. The idea is that we take an input graph, colour its vertices with colours from $C$, copy each vertex $k$ times, and then use the formulas from item~\ref{msotrans:formulas} to define a new graph structure. Since there are many ways of choosing the colouring, the same input graph might lead to several different output graphs. A more formal definition is given below.

%  Consider an input graph $G$ together with a colouring $\lambda$ of the vertices by colours from $C$.  Consider a relational structure   which is defined as follows. The universe is pairs $(x,i)$ such that $x$ is either a vertex or edge in $G$, and $i \in \set{1,\ldots,k}$. The   vocabulary is the same as in item~\ref{msotrans:formulas} of Definition~\ref{def:graph-to-graph-mso}, with the relations from the vocabulary interpreted as follows:
% \begin{align*}
% \mathrm{incident} = & \set{((v,i),(e,i)) : (v,e) \text{ is incident in $G$ and $i \in \set{1,\ldots,k}$}}\\
% \mathrm{copy} = & \set{((v,1),\ldots,(v,k)) : \text{$v$ is a vertex of $G$ and $i \in \set{1,\ldots,k}$}} \\
% \mathrm{color}_c = & \set{(v,i) : \text{$v$ is a vertex of $G$ with colour $c$ and $i \in \set{1,\ldots,k}$}}
% \end{align*}
% Define  $G_\lambda$ to be the relational structure,   with one binary incidence relation, which arises from the above relational structure by restricting the universe to those elements which satisfy the universe formula, and defining the incidence relation to be those pairs which satisfy the incidence formula.  The semantics of the \mso interpretation is defined to be 
% \begin{align*}
% \set{(G,H) : \text{the \msotwo encoding of $H$ is isomorphic to $G_\lambda$, for some $\lambda$}}
% \end{align*}
 A \emph{transduction}, with input vocabulary $\tau$ and output vocabulary $\sigma$ is defined to be a set of pairs 
\begin{align*}
    (\myunderbrace{\text{model over $\tau$}}{input model}, \ 
    \myunderbrace{\text{model over $\sigma$}}{output model}),
\end{align*}
which is isomorphism invariant, in the sense that membership in the transduction is not affected by changing a model -- on either the input or output coordinate -- to an isomorphic one. The central topic of this paper is transductions that can be defined using \mso, as described in the following definition, whose phrasing is based on~\cite[p.~9--10]{bojanczykOptimizingTreeDecompositions2017a}. 

\begin{definition}[\mso transduction]\label{def:mso-transduction}
    An \mso transduction is any transduction that can be obtained by composing a finite number of transductions of the following kinds.
Kind 1 is a partial function, kinds 2, 3, 4 are functions, and kind 5 is a relation.
\begin{enumerate}
	\item {\bf Filtering.} \label{mso-trans:filtering} For every \mso sentence $\varphi$ over the input vocabulary there is a transduction that filters out models where $\varphi$ is violated. Formally, the transduction is the partial identity -- with input and output vocabularies being equal --  whose domain consists of the models that satisfy the sentence. 
	\item {\bf Universe restriction.} For every \mso formula $\varphi(x)$ over the input vocabulary with one free first-order variable, there is a transduction, which restricts the universe of the input model to those elements that satisfy $\varphi$. The input and output vocabularies are the same, the interpretation of each relation in the output model is defined as the restriction of its interpretation 
	in the input model to tuples of elements that remain in the universe.
	\item {\bfseries{\scshape{Mso}} interpretation.} This kind of transduction changes the vocabulary of the model while keeping the universe intact. To specify an \mso interpretation, for for every relation name $R$ of the output vocabulary, one gives an \mso formula $\varphi_R(x_1,\ldots,x_k)$ over the input vocabulary which has as many free first-order variables as the arity of $R$. The output model is obtained from the input model by keeping the same universe, and interpreting each relation $R$ of the output vocabulary as the set of tuples  satisfying $\varphi_R$.
	\item {\bf Copying.} \label{mso-trans:copying} For  $k \in \set{1,2,\ldots}$, define $k$-copying to be the transduction which inputs a model and outputs a model consisting of $k$ disjoint copies of the input, with an additional relation that ties the copies together. Formally, the output universe consists of $k$ copies of the input universe.
	The output vocabulary is the input vocabulary enriched with a binary predicate $\mathsf{copy}$ which selects pairs which originate from the same element, and unary predicates $\mathsf{layer}_1,\mathsf{layer}_2,\ldots,\mathsf{layer}_k$ which select elements belonging to the first, second, etc. copies of the universe.
	In the output model, a relation name $R$ of the input vocabulary is interpreted as the set of all those tuples over the output model, which are in the same layer, and  where the original elements of the copies were in relation $R$
	in the input model.
	\item {\bf Colouring.} \label{mso-trans:colouring} Colouring adds  a new unary predicate to the input model, and interprets it nondeterministically. Formally, the universe as well as the interpretations of all relation names of the input vocabulary stay intact,
	but the output vocabulary has one more unary predicate. For every possible interpretation of this unary predicate, there is a different output with this interpretation implemented.
\end{enumerate}
\end{definition}

\smallparagraph{The equivalence problem}  Define a \emph{graph-to-graph \mso transduction} to be an \mso transduction, where the input and output vocabularies are the same, namely the vocabulary of graphs (one binary relation for incidence), and which only contains pairs of graphs (more formally, pairs of \msotwo models of graphs).  By abuse of notation, when $\Tt$ is a graph-to-graph \mso transduction, and $G,H$ are graphs, we write $(G,H) \in \Tt$ instead of the formally correct 
\begin{align*}
(\text{\msotwo model of $G$}, \text{\msotwo model of $H$})\in \Tt.
\end{align*}
If $\Tt$ is functional, which means that for every input graph there is at most one output graph up to isomorphism, then we write $\Tt(G)$ for the (isomorphism type of the) resulting graph (which may be undefined).
The topic of this paper is   the following  decision problem for functional \mso graph-to-graph transductions, which  we do not know how to solve.


\decisionproblem{equivalence for functional graph-to-graph \mso transductions of bounded treewidth.}{ $\ell, k \in \set{1,2,\ldots}$ and two functional graph-to-graph \mso transductions $\Tt_1,\Tt_2$.}{is it the case that for every input $G$ of treewidth at most $\ell$, the two outputs  $\Tt_1(G),\Tt_2(G)$ are isomorphic and have treewidth at most $k$?}

If the  transductions in the instance are not functional, then there are no requirements on the answer to the algorithm. This motivates the following problem:

\decisionproblem{functionality for graph-to-graph \mso transdcutions of bounded treewidth.}{ $\ell, k \in \set{1,2,\ldots}$ and a graph-to-graph \mso transduction,  not necessarily functional.}{is there some input of treewidth at most $\ell$,  which can produce  at least two non-isomorphic outputs of treewidth at most $k$?}
    


\begin{fact}\label{fact:equi-decidable}
    The equivalence and functionality problems described above are equi-decidable, i.e.~if one is decidable then the other is decidable. 
\end{fact}
\begin{proof}
    %(fill-in)
    Equivalence reduces to functionality, because two transductions are  equivalent if and only if they have the same domains when restricted to treewidth at most $\ell$, and their union is  functional, when restricted to inputs of treewidth at most $\ell$ and outputs of treewidth at most $k$.  The domain of an \mso transduction can be effectively constructed as an \mso sentence~\cite[Backwards Translation Theorem]{courcelleGraphStructureMonadic2012}, while equivalence for \mso sentences on graphs of bounded treewidth is decidable~\cite[Theorem 5.80]{courcelleGraphStructureMonadic2012}.

    Consider now the converse reduction: from functionality to equivalence. Suppose that $\Tt$ is an \mso transduction, and we want to check if $\Tt$ is functional for inputs of treewidth at most $\ell$ and outputs of treewidth at most $k$. Because colourings can be pushed to the head of an \mso transduction, see~\cite[Section 1.7]{courcelleGraphStructureMonadic2012}, we can decomposed $\Tt$ as a  composition $\mathcal T =  \mathcal F \circ \mathcal S$, where:
    \begin{itemize}
        \item $\mathcal C$ is a colouring, i.e.~a composition of transduction as in item~\ref{mso-trans:colouring} of Definition~\ref{def:mso-transduction}.
        \item $\mathcal F$ is a composition of transductions from items~\ref{mso-trans:filtering}-\ref{mso-trans:copying} of Definition~\ref{def:mso-transduction}.
    \end{itemize}
    In particular, since items~\ref{mso-trans:filtering}-\ref{mso-trans:copying} of Definition~\ref{def:mso-transduction} describe partial functions, it follows that $\mathcal F$ is a partial function. There is some finite set of colours $C$ (more precisely, if $\Ff$ is a composition of $n$ copying transductions, then $C=2^n$) such that the  transduction $\mathcal C$ inputs a graph, and nondeterministically outputs a $C$-coloured graph (i.e.~a graph with vertices labelled by colours from $C$). For $i  \in \set{1,2}$, define $\Ff_i$ to be the \mso transduction which inputs a $(C \times C)$-coloured  graph, projects the colours to the $i$-th coordinate, and then applies $\Ff$. The transduction $\Tt$ is functional if and only if the transductions $\Ff_1$ and $\Ff_2$ are equivalent (and the same statement is true if we restrict inputs and outputs to have given treewidth). Therefore, the functionality problem reduces to the equivalence problem for coloured graphs. Finally, colours can be simulated by the graph structure without affecting treewidth,  as explained in the following picture:
    \mypic{5}
    Let $\Tt$ be the \mso transduction from coloured graphs to uncoloured graphs, and let $\Tt^{-1}$ be its one-sided inverse, which is a partial function from uncoloured graphs to coloured graphs:
    \begin{align*}
        \xymatrix@C=3cm{
            \text{$C$-coloured graphs}
            \ar@/^1pc/[r]^-{\Tt} &
            \text{graphs}.
            \ar@/^1pc/[l]^-{\text{partial function }\Tt^{-1}}
        }
        \end{align*}
    Both partial functions in the above diagram do not change treewidth. 
    Two functional \mso transductions $\Ff_1$ and $\Ff_2$  from coloured graphs to coloured graphs are equivalent if and only if the functional graph-to-graph \mso transductions  $\Tt \circ \Ff_1 \circ \Tt^{-1}$ and $\Tt \circ \Ff_2 \circ \Tt^{-1}$ are equivalent. 
     Therefore, the functionality and equivalence problems for coloured graphs reduce to the same problems for un-coloured graphs.
    % (constructing $T_1 \vee T_2$ can be done e.g. by adding a coordinate to colouring that tells which one of $T_1$, $T_2$ is used). For the opposite direction, functionality can be reduced to equivalence of transductions where input is labelled: for a given transduction $T$, test equivalence of two (deterministic) transductions that input graphs labelled with pairs of colours used by $T$ and execute $T$, using first, respectively second colouring. (fill-in (resolve labelled input))
    % For every $k \in \set{1,2\ldots}$, the set of graphs of treewidth $k$ is \mso definable.  (A quick justification is that the graphs of treewidth $> k$ are characterised by forbidden minors~\cite{}, and having a fixed graph as a minor is an \mso definable property.) Therefore, thanks to the filtering step in \mso transductions, we can assume that the the two \mso transductions in the instance of the above decision problem have only outputs of treewidth at most $\ell$, and have only outputs of treewidth at most $k$. 
\end{proof}

The rest of this paper is devoted to a discussion of the above two problems, including a solution for a variant where output graphs are identified up to a relaxation of isomorphism.
%As we explain below, we do not even know how to solve the problem for $k=\ell=1$, i.e.~for \mso transductions which input and output forests.
We begin with two examples which illustrate the fact that equivalence problem for graph-to-graph transductions remains unsolved even for very restricted instances.

\begin{example}
    Consider the special case of the equivalence problem for functional graph-to-graph \mso transductions of bounded treewidth, where both input and output graphs have treewidth 1. (As we will see in Lemma~\ref{lem:transduction-to-registers}, it is the output treewidth that is important, since the input treewidth can always be reduced to 1 without making the problem any easier.) This very special case of the equivalence problem, to our best knowledge, has not been solved yet.
    
    Let us compare this special case with a very similar problem that is already known to be decidable. 
    Graphs of treewidth 1 are forests, and therefore in this special case, we are talking about the equivalence problem for functional \mso transductions that input and output forests.  In~\cite[Section 3]{boiretReducingTransducerEquivalence2018}, a similar problem was considered and shown decidable,  except that the forests were rooted (every tree in the forest has a distinguished root).  Rooted forests can be encoded in (un-rooted) forests, in the following sense: there exist functional \mso transductions
    \begin{align*}
        \xymatrix@C=3cm{
            \text{rooted forests}
            \ar@/^1pc/[r]^-{\Tt} &
            \text{un-rooted forests},
            \ar@/^1pc/[l]^-{\text{partial function }\Tt^{-1}}
        }
        \end{align*}
        such that $\Tt^{-1} \circ \Tt$ is the identity on rooted forests. (For example, $\Tt$  can subdivide each edge with an extra node, and then add two extra children for the root, so that it becomes the unique tree node with two neighbours that are leaves.) Therefore, for the same reasons as in Fact~\ref{fact:equi-decidable}, the equivalence problem for rooted forests reduces to the equivalence problem for un-rooted forests. Unfortunately, we do not know of a reduction in the other direction. One idea would be to transform an un-rooted tree into the rooted forest of all possible ways of choosing a root; this transformation has quadratic size outputs, and therefore it cannot be an \mso transduction.

        This example also illustrates a phenomenon in the equivalence problem for \mso transductions: the problem is typically harder for structures with more automorphisms, e.g.~non-rooted forests are harder than rooted forests. Another instance of this phenomenon is that equivalence for forests (which do not have a sibling order) is a more general problem than equivalence for forests with a sibling order -- the latter can be encoded in former, in the above sense, as described by the following picture (J:fill-in może obrazek?).
    \end{example}   

		Let us move another to example, which also remains unsolved.
    \begin{example}
        Define \emph{cyclic equivalence} to be the equivalence relation $\sim$ on strings which identifies two words modulo cyclic shifts:
        \begin{align*}
            \text{abbac} \sim
            \text{cabba} \sim
            \text{acabb} \sim
            \text{bacab} \sim
            \text{bbaca}   .
         \end{align*}
         Consider the following  problem: given two functional string-to-string \mso transductions~\cite[Definition 1]{engelfrietMSODefinableString2001},
        decide if for every input string, the two output strings are equal  modulo cyclic equivalence. %	This seems to be an entertaining problem.
         It is a special case of the graph-to-graph equivalence problem, since  strings modulo cyclic equivalence  can be represented as graphs of treewidth at most 2, as explained in the following picture:
        \mypic{9}
        \end{example}